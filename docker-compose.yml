version: "3.4"
x-restart-policy: &restart_policy
  restart: unless-stopped
x-dispatch-defaults: &dispatch_defaults
  <<: *restart_policy
  env_file:
    - .env
  build:
    # TODO Update when https://github.com/Netflix/dispatch/pull/53 lands
    context: https://github.com/TheDahv/dispatch.git#develop__fix-docker-image-startup:.
  image: dispatch-local
  depends_on:
    - postgres
services:
  postgres:
    <<: *restart_policy
    image: "postgres:9.6"
    volumes:
      - "dispatch-postgres:/var/lib/postgresql/data"
  web:
    <<: *dispatch_defaults
    command: ["server", "start", "dispatch.main:app"]
  dispatch-scheduler:
    <<: *dispatch_defaults
    command: ["scheduler", "start"]
volumes:
  dispatch-postgres:
    external: true
